{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["import * as utils from \"@iobroker/adapter-core\";\r\nimport { getEpmDetails, getInverterDetails, getInverterList, getStationDetails } from \"./lib/apiHelper\";\r\nimport { createObjects } from \"./lib/createObjects\";\r\n\r\nclass soliscloud extends utils.Adapter {\r\n\tprivate intervalId: any;\r\n\tpublic constructor(options: Partial<utils.AdapterOptions> = {}) {\r\n\t\tsuper({\r\n\t\t\t...options,\r\n\t\t\tname: \"soliscloud\",\r\n\t\t});\r\n\t\tthis.on(\"ready\", this.onReady.bind(this));\r\n\t\tthis.on(\"unload\", this.onUnload.bind(this));\r\n\t}\r\n\r\n\tprivate async onReady(): Promise<void> {\r\n\t\tthis.log.info(\"Starting soliscloud adapter\");\r\n\r\n\t\tif (this.config.plantId != null) {\r\n\t\t\tthis.config.plantId = this.name2id(this.config.plantId);\r\n\t\t\tcreateObjects(this);\r\n\t\t} else {\r\n\t\t\tthis.log.error(\"No plantID was entered or it contains invalid characters.\");\r\n\t\t}\r\n\r\n\t\tif (this.configOK()) {\r\n\t\t\tthis.log.info(\r\n\t\t\t\t`Start polling soliscloud, polling every ${this.config.pollInterval} seconds`,\r\n\t\t\t);\r\n\t\t\tthis.intervalId = this.setInterval(async () => {\r\n\t\t\t\tawait this.pollSolis();\r\n\t\t\t}, this.config.pollInterval * 1000);\r\n\t\t} else {\r\n\t\t\tthis.log.error(\"Config seems to be invalid, NOT polling.\");\r\n\t\t}\r\n\t}\r\n\r\n\tprivate name2id(pName: string): string {\r\n\t\treturn (pName || \"\").replace(this.FORBIDDEN_CHARS, \"_\");\r\n\t}\r\n\r\n\tprivate configOK(): boolean {\r\n\t\tif (\r\n\t\t\tthis.config.apiKey &&\r\n\t\t\tthis.config.plantId &&\r\n\t\t\ttypeof this.config.pollInterval === \"number\" &&\r\n\t\t\tthis.config.pollInterval >= 45 &&\r\n\t\t\tthis.config.pollInterval <= 1800\r\n\t\t) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\r\n\tprivate async pollSolis(): Promise<void> {\r\n\t\ttry {\r\n\t\t\tconst callResult = await getStationDetails(\r\n\t\t\t\tthis\r\n\t\t\t);\r\n\r\n\t\t\tif (callResult) {\r\n\t\t\t\tif (this.config.debugLogging) {\r\n\t\t\t\t\tthis.log.debug(\"Received result from API call, current consumption should be: \" + callResult.current_consumption);\r\n\t\t\t\t}\r\n\t\t\t\tlet plantStatus = \"\";\r\n\t\t\t\tswitch (callResult.plant_state) {\r\n\t\t\t\t\tcase 1:\r\n\t\t\t\t\t\tplantStatus = \"Online\";\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 2:\r\n\t\t\t\t\t\tplantStatus = \"Offline\";\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 3:\r\n\t\t\t\t\t\tplantStatus = \"Alarm\";\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tthis.log.error(`Received an incorrect plant status from the API Call, this should NOT happen.`)\r\n\t\t\t\t\t\tthis.logErrorWithSentry(this, callResult.plant_state, \"incorrectPlantState\");\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tif (this.config.debugLogging) {\r\n\t\t\t\t\tthis.log.debug(`Plant ${this.config.plantId} is ${plantStatus}`);\r\n\t\t\t\t}\r\n\t\t\t\tawait this.setStateAsync(\r\n\t\t\t\t\t`${this.config.plantId}.station_detail.plant_state`,\r\n\t\t\t\t\t{ val: plantStatus, ack: true }\r\n\t\t\t\t);\r\n\r\n\t\t\t\tconst properties = [\r\n\t\t\t\t\t\"current_consumption\",\r\n\t\t\t\t\t\"current_power\",\r\n\t\t\t\t\t\"current_from_net\",\r\n\t\t\t\t\t\"sold_today\",\r\n\t\t\t\t\t\"generated_today\",\r\n\t\t\t\t\t\"bought_today\",\r\n\t\t\t\t\t\"consumption_today\",\r\n\t\t\t\t\t\"battery_percent\",\r\n\t\t\t\t\t\"battery_current_usage\",\r\n\t\t\t\t\t\"total_consumption_energy\",\r\n\t\t\t\t\t\"self_consumption_energy\",\r\n\t\t\t\t\t\"battery_month_charge_energy\",\r\n\t\t\t\t\t\"battery_month_charge_energy_units\",\r\n\t\t\t\t\t\"battery_year_charge_energy\",\r\n\t\t\t\t\t\"battery_year_charge_energy_units\",\r\n\t\t\t\t\t\"battery_month_discharge_energy\",\r\n\t\t\t\t\t\"battery_month_discharge_energy_units\",\r\n\t\t\t\t\t\"battery_year_discharge_energy\",\r\n\t\t\t\t\t\"battery_year_discharge_energy_units\",\r\n\t\t\t\t];\r\n\t\t\t\tfor (const property of properties) {\r\n\t\t\t\t\tawait this.setStateAsync(\r\n\t\t\t\t\t\t`${this.config.plantId}.station_detail.${property}`,\r\n\t\t\t\t\t\t{ val: callResult[property], ack: true }\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tthis.logErrorWithSentry(this, callResult, \"stationCallResult\");\r\n\t\t\t}\r\n\t\t} catch (e) {\r\n\t\t\tthis.logErrorWithSentry(this, e, \"getStationDetails\");\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tconst inverterDetailResult = await getInverterList(\r\n\t\t\t\tthis\r\n\t\t\t);\r\n\t\t\tif (inverterDetailResult) {\r\n\t\t\t\tthis.log.debug(`Correct result from Inverter API call, inverter state: ${inverterDetailResult.inverter_state}`)\r\n\t\t\t\tlet inverterStatus = \"\";\r\n\r\n\t\t\t\tswitch (inverterDetailResult.inverter_state) {\r\n\t\t\t\t\tcase 1:\r\n\t\t\t\t\t\tinverterStatus = \"Online\";\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 2:\r\n\t\t\t\t\t\tinverterStatus = \"Offline\";\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 3:\r\n\t\t\t\t\t\tinverterStatus = \"Alarm\";\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tthis.log.error(`Received an incorrect plant status from the inverter API Call, this should NOT happen.`)\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tthis.log.debug(`set inverter state to: ${inverterStatus}`)\r\n\t\t\t\tawait this.setStateAsync(\r\n\t\t\t\t\t`${this.config.plantId}.inverter_detail.energy_day`,\r\n\t\t\t\t\t{ val: inverterDetailResult.etoday, ack: true },\r\n\t\t\t\t);\r\n\t\t\t\tawait this.setStateAsync(\r\n\t\t\t\t\t`${this.config.plantId}.inverter_detail.state`,\r\n\t\t\t\t\t{ val: inverterStatus, ack: true },\r\n\t\t\t\t);\r\n\t\t\t\tawait this.setStateAsync(\r\n\t\t\t\t\t`${this.config.plantId}.inverter_detail.id`,\r\n\t\t\t\t\t{ val: inverterDetailResult.inverter_id, ack: true },\r\n\t\t\t\t);\r\n\t\t\t\tawait this.setStateAsync(\r\n\t\t\t\t\t`${this.config.plantId}.inverter_detail.serial_number`,\r\n\t\t\t\t\t{ val: inverterDetailResult.inverter_serial_number, ack: true },\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t} catch (e) {\r\n\t\t\tthis.log.error(`error while calling API (Inverter): ${e}`);\r\n\t\t\tthis.logErrorWithSentry(this, e, \"getInverterList\");\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tthis.getState(`${this.config.plantId}.inverter_detail.id`, async (err, state) => {\r\n\t\t\t\tif (!err && state && state.val) {\r\n\t\t\t\t\tconst inverterId = state.val.toString();\r\n\t\t\t\t\tif (this.config.debugLogging) {\r\n\t\t\t\t\t\tthis.log.debug(`The value of ${this.config.plantId}.inverter_detail.id is ${inverterId}`);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst inverterDetails = await getInverterDetails(this);\r\n\t\t\t\t\tif (inverterDetails) {\r\n\t\t\t\t\t\tconst propertiesToSet = [\r\n\t\t\t\t\t\t\t\"ac_current_R\",\r\n\t\t\t\t\t\t\t\"ac_current_S\",\r\n\t\t\t\t\t\t\t\"ac_current_T\",\r\n\t\t\t\t\t\t\t\"ac_voltage_R\",\r\n\t\t\t\t\t\t\t\"ac_voltage_S\",\r\n\t\t\t\t\t\t\t\"ac_voltage_T\",\r\n\t\t\t\t\t\t\t\"family_load_power_units\",\r\n\t\t\t\t\t\t\t\"family_load_power\",\r\n\t\t\t\t\t\t\t\"temperature\",\r\n\t\t\t\t\t\t\t\"battery_today_charge_energy\",\r\n\t\t\t\t\t\t\t\"battery_today_charge_energy_units\",\r\n\t\t\t\t\t\t\t\"battery_total_charge_energy\",\r\n\t\t\t\t\t\t\t\"battery_total_charge_energy_units\",\r\n\t\t\t\t\t\t\t\"battery_today_discharge_energy\",\r\n\t\t\t\t\t\t\t\"battery_today_discharge_energy_units\",\r\n\t\t\t\t\t\t\t\"battery_total_discharge_energy\",\r\n\t\t\t\t\t\t\t\"battery_total_discharge_energy_units\",\r\n\t\t\t\t\t\t];\r\n\r\n\t\t\t\t\t\tpropertiesToSet.forEach(async (property) => {\r\n\t\t\t\t\t\t\tconst stateKey = `${this.config.plantId}.inverter_detail.${property}`;\r\n\t\t\t\t\t\t\tawait this.setStateAsync(stateKey, { val: inverterDetails[property], ack: true });\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.log.error(`Error getting the state: ${err}`);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} catch (e) {\r\n\t\t\tthis.logErrorWithSentry(this, e, \"getStateInverterDetails\");\r\n\t\t}\r\n\r\n\t\tif (this.config.epm) {\r\n\t\t\tthis.log.info(\"EPM is enabled, making API call\");\r\n\t\t\tgetEpmDetails(this);\r\n\t\t}\r\n\t}\r\n\r\n\tprivate onUnload(callback: () => void): void {\r\n\t\ttry {\r\n\t\t\tthis.log.info(\"Stopping soliscloud polling\");\r\n\t\t\tthis.clearInterval(this.intervalId);\r\n\t\t\tcallback();\r\n\t\t} catch (e) {\r\n\t\t\tthis.logErrorWithSentry(this, e, \"onUnload\");\r\n\t\t\tcallback();\r\n\t\t}\r\n\t}\r\n\r\n\tprivate logErrorWithSentry(adapter: any, error: any, functionName: string): void {\r\n\t\tadapter.log.error(error);\r\n\t\tif (adapter.supportsFeature && adapter.supportsFeature(\"PLUGINS\")) {\r\n\t\t\tconst sentryInstance = adapter.getPluginInstance(\"sentry\");\r\n\t\t\tif (sentryInstance) {\r\n\t\t\t\tsentryInstance.getSentryObject().captureException(error, {\r\n\t\t\t\t\textra: {\r\n\t\t\t\t\t\tfunctionName: functionName,\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nif (require.main !== module) {\r\n\tmodule.exports = (options: Partial<utils.AdapterOptions> | undefined) =>\r\n\t\tnew soliscloud(options);\r\n} else {\r\n\t(() => new soliscloud())();\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
