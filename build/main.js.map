{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["import * as utils from \"@iobroker/adapter-core\";\nimport { getStationDetails } from \"./lib/apiHelper\";\nimport \"./lib/apiHelper\";\n\nclass soliscloud extends utils.Adapter {\n  private running = false;\n  public constructor(options: Partial<utils.AdapterOptions> = {}) {\n    super({\n      ...options,\n      name: \"soliscloud\",\n    });\n    this.on(\"ready\", this.onReady.bind(this));\n    // this.on(\"stateChange\", this.onStateChange.bind(this));\n    // this.on(\"objectChange\", this.onObjectChange.bind(this));\n    // this.on(\"message\", this.onMessage.bind(this));\n    this.on(\"unload\", this.onUnload.bind(this));\n  }\n\n  private async onReady(): Promise<void> {\n    this.log.info(\"Starting soliscloud adapter\");\n\n    if (this.config.plantId != null) {\n      await this.setObjectNotExistsAsync(\n        `${this.config.plantId}.current_consumption`,\n        {\n          type: \"state\",\n          common: {\n            name: \"current_consumption\",\n            type: \"number\",\n            unit: \"kW\",\n            role: \"value\",\n            read: true,\n            write: true,\n          },\n          native: {},\n        },\n      );\n\n      await this.setObjectNotExistsAsync(\n        `${this.config.plantId}.current_power`,\n        {\n          type: \"state\",\n          common: {\n            name: \"current_power\",\n            type: \"number\",\n            unit: \"kW\",\n            role: \"value\",\n            read: true,\n            write: true,\n          },\n          native: {},\n        },\n      );\n\n      await this.setObjectNotExistsAsync(\n        `${this.config.plantId}.current_from_net`,\n        {\n          type: \"state\",\n          common: {\n            name: \"current_from_net\",\n            type: \"number\",\n            unit: \"kW\",\n            role: \"value\",\n            read: true,\n            write: true,\n          },\n          native: {},\n        },\n      );\n\n      await this.setObjectNotExistsAsync(`${this.config.plantId}.sold_today`, {\n        type: \"state\",\n        common: {\n          name: \"sold_today\",\n          type: \"number\",\n          unit: \"kWh\",\n          role: \"value\",\n          read: true,\n          write: true,\n        },\n        native: {},\n      });\n      await this.setObjectNotExistsAsync(\n        `${this.config.plantId}.generated_today`,\n        {\n          type: \"state\",\n          common: {\n            name: \"generated_today\",\n            type: \"number\",\n            unit: \"kWh\",\n            role: \"value\",\n            read: true,\n            write: true,\n          },\n          native: {},\n        },\n      );\n\n      await this.setObjectNotExistsAsync(\n        `${this.config.plantId}.bought_today`,\n        {\n          type: \"state\",\n          common: {\n            name: \"bought_today\",\n            type: \"number\",\n            unit: \"kWh\",\n            role: \"value\",\n            read: true,\n            write: true,\n          },\n          native: {},\n        },\n      );\n\n      await this.setObjectNotExistsAsync(\n        `${this.config.plantId}.consumption_today`,\n        {\n          type: \"state\",\n          common: {\n            name: \"consumption_today\",\n            type: \"number\",\n            unit: \"kWh\",\n            role: \"value\",\n            read: true,\n            write: true,\n          },\n          native: {},\n        },\n      );\n\n      await this.setObjectNotExistsAsync(\n        `${this.config.plantId}.battery_percent`,\n        {\n          type: \"state\",\n          common: {\n            name: \"battery_percent\",\n            type: \"number\",\n            unit: \"%\",\n            role: \"value\",\n            read: true,\n            write: true,\n          },\n          native: {},\n        },\n      );\n\n      await this.setObjectNotExistsAsync(\n        `${this.config.plantId}.battery_current_usage`,\n        {\n          type: \"state\",\n          common: {\n            name: \"battery_current_usage\",\n            type: \"number\",\n            unit: \"kW\",\n            role: \"value\",\n            read: true,\n            write: true,\n          },\n          native: {},\n        },\n      );\n    }\n\n    if (this.config.apiKey && this.config.apiSecret && this.config.plantId) {\n      this.log.info(\n        `Start polling soliscloud, polling every ${this.config.pollInterval} seconds`,\n      );\n      this.running = true;\n      //TODO change to use interval\n      while (this.running) {\n        try {\n          const callResult = await getStationDetails(\n            this.config.plantId,\n            this.config.apiKey,\n            this.config.apiSecret,\n          );\n          await this.setStateAsync(\n            `${this.config.plantId}.current_consumption`,\n            callResult?.current_consumption,\n          );\n          await this.setStateAsync(\n            `${this.config.plantId}.current_power`,\n            callResult?.current_power,\n          );\n          await this.setStateAsync(\n            `${this.config.plantId}.current_from_net`,\n            callResult?.current_from_net,\n          );\n          await this.setStateAsync(\n            `${this.config.plantId}.sold_today`,\n            callResult?.sold_today,\n          );\n          await this.setStateAsync(\n            `${this.config.plantId}.generated_today`,\n            callResult?.generated_today,\n          );\n          await this.setStateAsync(\n            `${this.config.plantId}.bought_today`,\n            callResult?.bought_today,\n          );\n          await this.setStateAsync(\n            `${this.config.plantId}.consumption_today`,\n            callResult?.consumption_today,\n          );\n          await this.setStateAsync(\n            `${this.config.plantId}.battery_percent`,\n            callResult?.battery_percent,\n          );\n          await this.setStateAsync(\n            `${this.config.plantId}.battery_current_usage`,\n            callResult?.battery_current_usage,\n          );\n\n          //Wait 30 seconds and loop again. #TODO make interval configurable\n          await new Promise((resolve) => setTimeout(resolve, 30000));\n        } catch (e) {\n          this.log.error(\n            `Error while calling solis api, retrying in ${this.config.pollInterval} seconds.`,\n          );\n          this.log.error(`Error was: ${e}`);\n          await new Promise((resolve) =>\n            setTimeout(resolve, this.config.pollInterval * 1000),\n          );\n        }\n      }\n    } else {\n      this.log.error(\"Can't start polling, missing needed settings.\");\n    }\n  }\n  /**\n   * Is called when adapter shuts down - callback has to be called under any circumstances!\n   */\n  private onUnload(callback: () => void): void {\n    try {\n      this.log.info(\"Stopping soliscloud polling\");\n      this.running = false;\n      callback();\n    } catch (e) {\n      this.log.info(\"Error while stopping polling: \" + e);\n      callback();\n    }\n  }\n}\n\nif (require.main !== module) {\n  // Export the constructor in compact mode\n  module.exports = (options: Partial<utils.AdapterOptions> | undefined) =>\n    new soliscloud(options);\n} else {\n  // otherwise start the instance directly\n  (() => new soliscloud())();\n}\n"],
  "mappings": "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",
  "names": ["import_apiHelper"]
}
